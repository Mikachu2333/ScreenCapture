name: AutoBuild

on:
  push:
    branches: ["main", "add_auto_build"]
    paths-ignore:
      - ".gitignore"
      - "*.md"
      - "**.txt"
      - "LICENSE"
  pull_request:
    branches: ["main", "add_auto_build"]
    paths-ignore:
      - ".gitignore"
      - "*.md"
      - "**.txt"
      - "LICENSE"
  workflow_dispatch:

env:
  CARGO_TERM_COLOR: always
  CMAKE_BUILD_PARALLEL_LEVEL: 4

jobs:
  build:
    runs-on: windows-latest
    permissions:
      contents: write
      actions: write

    env:
      QT_DIR: ${{ github.workspace }}/Qt
      QtMSBuild: ${{ github.workspace }}/QtMSBuild
      QT_VERSION: "6.9.0-static_msvc2022_64"

    steps:
      - uses: actions/checkout@v4

      - name: Add msbuild to PATH
        uses: microsoft/setup-msbuild@v2
        with:
          msbuild-architecture: x64

      - name: Install Qt # Dir: msvc2022_64
        shell: pwsh
        run: |
          mkdir ${{ env.QT_DIR }}
          $url = "https://github.com/yuanpeirong/buildQt/releases/download/Qt6.9.0_rev0/Qt_6.9.0-static-Release_msvc2022_64.7z"
          $output = "$env:TEMP\qt-static.7z"
          Invoke-WebRequest -Uri $url -OutFile $output
          Expand-Archive -Path $output -DestinationPath ${{ env.QT_DIR }} -Force

      - name: Install QtMSBuild
        shell: pwsh
        run: |
          $url = "https://download.qt.io/official_releases/vsaddin/3.3.1/qt-vsaddin-msbuild-3.3.1.zip"
          $output = "$env:TEMP\qt-vsaddin-msbuild.zip"
          $qtMsBuildDir = "${{ env.QtMSBuild }}"

          Write-Host "Downloading Qt VSADDIN MSBuild from $url"
          Invoke-WebRequest -Uri $url -OutFile $output

          Write-Host "Creating directory: $qtMsBuildDir"
          New-Item -ItemType Directory -Force -Path $qtMsBuildDir | Out-Null

          Write-Host "Extracting files to $qtMsBuildDir"
          Expand-Archive -Path $output -DestinationPath $qtMsBuildDir -Force

          Write-Host "QtMSBuild installation completed"

      - name: Tree
        run: tree ${{ github.workspace }} /f

      - name: Build
        shell: pwsh
        run: |
          msbuild `
          -p:Configuration=Release `
          -p:Platform=x64 `
          -p:QtInstall=${{ env.QT_VERSION }} `
          -p:QTDir=${{ env.QT_DIR }}/${{ env.QT_VERSION }}/mingw1420_64_UCRT `
          -p:QtMsBuild=${{ env.QtMSBuild }} `
          ./ScreenCapture.sln

      - name: Upload Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: ScreenCapture-Release
          path: release-package
